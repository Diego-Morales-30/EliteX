@model IEnumerable<FileData.Models.Empleado>

<link rel="stylesheet" href="~/Estilos/DashConsultar.css" />

<div class="tabla-consultar-container">
    <h1 class="titulo-consultar">🔎 Consultar Empleado</h1>

    <input type="text" id="txtBuscar" class="input-buscar" placeholder="Ingrese ID o nombre completo" />
    <button id="btnBuscar" class="btn-buscar">Buscar</button>

    <div id="resultadoEmpleado" class="resultado-empleado">
        <p>Ingrese un filtro y presione "Buscar" para ver los empleados.</p>
    </div>
</div>

<!-- Modal/Panel interno para Actualizar (inicia oculto) -->
<div id="modalActualizar" class="modal-actualizar" style="display:none;">
    <div class="modal-content-actualizar">
        <div class="modal-header-actualizar">
            <h2>✏️ Actualizar Empleado</h2>
            <button id="cerrarModal" class="btn-cerrar-modal" title="Cerrar">✖</button>
        </div>

        <form id="formActualizarInline">
            <input type="hidden" name="IdEmpleado" id="IdEmpleado" />

            <div class="campo">
                <label for="Nombre">Nombre</label>
                <input name="Nombre" id="Nombre" type="text" required />
            </div>

            <div class="campo">
                <label for="Apellidos">Apellidos</label>
                <input name="Apellidos" id="Apellidos" type="text" required />
            </div>

            <div class="campo">
                <label for="FechaNacimiento">Fecha de Nacimiento</label>
                <input name="FechaNacimiento" id="FechaNacimiento" type="date" />
            </div>

            <div class="campo">
                <label for="Edad">Edad</label>
                <input name="Edad" id="Edad" type="number" min="0" />
            </div>

            <div class="campo">
                <label for="EstadoCivil">Estado Civil</label>
                <input name="EstadoCivil" id="EstadoCivil" type="text" />
            </div>

            <div class="campo">
                <label for="Email">Email</label>
                <input name="Email" id="Email" type="email" />
            </div>

            <div class="campo">
                <label for="Telefono">Teléfono</label>
                <input name="Telefono" id="Telefono" type="text" />
            </div>

            <div class="campo">
                <label for="Dni">DNI</label>
                <input name="Dni" id="Dni" type="text" />
            </div>

            <div class="acciones-modal">
                <button type="submit" class="btn-guardar-actualizar">Guardar</button>
                <button type="button" id="btnCancelarModal" class="btn-cancelar-actualizar">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<style>
    /* Estilos mínimos del modal para integrarlo visualmente */
    .modal-actualizar {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(2,6,23,0.6);
        z-index: 9999;
        padding: 20px;
    }

    .modal-content-actualizar {
        width: 760px;
        max-width: 98%;
        background: #0f1624;
        border-radius: 12px;
        padding: 22px;
        box-shadow: 0 8px 40px rgba(0,0,0,0.6);
        color: #e6eef8;
    }

    .modal-header-actualizar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
    }

    .btn-cerrar-modal {
        background: transparent;
        border: none;
        color: #cfe3ff;
        font-size: 18px;
        cursor: pointer;
    }

    .campo {
        display: flex;
        flex-direction: column;
        margin-bottom: 10px;
    }

        .campo label {
            font-weight: 600;
            margin-bottom: 6px;
            color: #d6e7ff;
        }

        .campo input {
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.06);
            background: rgba(255,255,255,0.02);
            color: #e6eef8;
        }

    .acciones-modal {
        margin-top: 12px;
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .btn-guardar-actualizar {
        padding: 10px 14px;
        border-radius: 8px;
        background: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        font-weight: 700;
    }

    .btn-cancelar-actualizar {
        padding: 10px 14px;
        border-radius: 8px;
        background: transparent;
        color: #cfe3ff;
        border: 1px solid rgba(255,255,255,0.04);
        cursor: pointer;
    }

    /* Botón "Actualizar" en cada bloque de resultado (si acaso no está en tu CSS) */
    .btn-actualizar {
        padding: 6px 10px;
        border-radius: 8px;
        background: transparent;
        color: #cfe3ff;
        border: 1px solid rgba(255,255,255,0.08);
        cursor: pointer;
        font-weight: 700;
        margin-left: 12px;
    }

    .btn-eliminar {
        background-color: #c0392b;
        color: #fff;
        border: none;
        padding: 5px 12px;
        border-radius: 5px;
        cursor: pointer;
        transition: 0.2s;
    }

        .btn-eliminar:hover {
            background-color: #e74c3c;
        }

    .modal-confirmacion {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 15, 30, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .modal-contenido {
        background: #1e2a38;
        color: white;
        padding: 25px 35px;
        border-radius: 12px;
        text-align: center;
        width: 380px;
    }

        .modal-contenido h3 {
            margin-bottom: 10px;
        }

        .modal-contenido p {
            font-size: 14px;
            opacity: 0.9;
        }

        .modal-contenido .acciones {
            margin-top: 20px;
            display: flex;
            justify-content: space-around;
        }

    .btn-confirmar {
        background: #d9534f;
        border: none;
        color: white;
        padding: 8px 18px;
        border-radius: 6px;
        cursor: pointer;
    }

        .btn-confirmar:hover {
            background: #c9302c;
        }

    .btn-cancelar {
        background: #6c757d;
        border: none;
        color: white;
        padding: 8px 18px;
        border-radius: 6px;
        cursor: pointer;
    }

        .btn-cancelar:hover {
            background: #5a6268;
        }

</style>

<script>
    $(document).ready(function () {
        var htmlInicial = $("#resultadoEmpleado").html();

        $("#btnBuscar").click(function () {
            let filtro = $("#txtBuscar").val().trim();
            if (filtro === "") return alert("Ingrese ID o nombre para buscar.");

            $("#resultadoEmpleado").html("Buscando...");

            $.post("/Consultar/BuscarEmpleado", { filtro: filtro }, function (res) {
                $("#resultadoEmpleado").html(res);
                agregarBotonesActualizar();
            }).fail(function () {
                $("#resultadoEmpleado").html("<p>Error al buscar empleado.</p>");
            });
        });

        function agregarBotonesActualizar() {
            $("#resultadoEmpleado").find("div").each(function () {
                var $block = $(this);
                if ($block.find("h3").length === 0) return;
                if ($block.find(".btn-actualizar").length) return;

                var id = null;
                $block.find("p").each(function () {
                    var t = $(this).text().replace(/\s+/g, " ").trim();
                    var m = t.match(/(?:\bID\b|\bId\b|identificador|identifica|id)\s*[:\s]*([0-9]+)/i);
                    if (m && m[1]) {
                        id = m[1];
                        return false;
                    }
                });
                if (!id) {
                    var fallback = $block.text().match(/\b([0-9]{1,6})\b/);
                    if (fallback) id = fallback[1];
                }
                if (!id) return;

                var $btnActualizar = $('<button type="button" class="btn-actualizar">Actualizar</button>');
                $btnActualizar.on("click", function () {
                    abrirModalConDatosDesdeBloque($block, id);
                });

                // === NUEVO: Botón eliminar ===
                var $btnEliminar = $('<button type="button" class="btn-eliminar">Eliminar</button>');
                $btnEliminar.on("click", function () {
                    mostrarConfirmacionEliminar(id);
                });

                if ($block.find("h3").length) {
                    var $h3 = $block.find("h3").first();
                    if (!$h3.parent().hasClass("h3-with-btn")) {
                        $h3.wrap('<div class="h3-with-btn" style="display:flex;align-items:center;justify-content:space-between;"></div>');
                    }

                    // Contenedor para ambos botones
                    var $btnContainer = $('<div style="display:flex;gap:8px;"></div>');
                    $btnContainer.append($btnActualizar, $btnEliminar);
                    $h3.parent().append($btnContainer);
                } else {
                    $block.append($btnActualizar, $btnEliminar);
                }
            });
        }

        // === NUEVO: Ventana emergente de confirmación ===
            function mostrarConfirmacionEliminar(id) {
        const modal = $(`
            <div class="modal-confirmacion">
                <div class="modal-contenido">
                    <div class="icono-eliminar">⚠️</div>
                    <h3>¿Deseas eliminar este empleado?</h3>
                    <p>Esta acción es permanente y no se puede deshacer.</p>
                    <div class="acciones">
                        <button id="confirmarEliminar" class="btn-confirmar">Sí, eliminar</button>
                        <button id="cancelarEliminar" class="btn-cancelar">Cancelar</button>
                    </div>
                </div>
            </div>
        `);

        $("body").append(modal);
        modal.hide().fadeIn(200);

        $("#cancelarEliminar").on("click", function () {
            modal.fadeOut(150, function () { modal.remove(); });
        });

        $("#confirmarEliminar").on("click", function () {
            $.ajax({
                url: '/EliminaEmpleado/EliminarEmpleadoConfirmado',
                type: 'POST',
                data: { id: id },
                success: function (res) {
                    modal.fadeOut(150, function () { modal.remove(); });
                    alert(res.message || "Empleado eliminado correctamente.");
                    $("#btnBuscar").click(); // Refresca la lista
                },
                error: function () {
                    modal.fadeOut(150, function () { modal.remove(); });
                    alert("Error al intentar eliminar el empleado.");
                }
            });
        });
    }


        // === FIN DE LA NUEVA FUNCIÓN ===

        function abrirModalConDatosDesdeBloque($block, id) {
            $("#IdEmpleado").val(id);
            var nombreCompleto = $block.find("h3").first().text().trim();
            var partes = nombreCompleto.split(" ");
            if (partes.length >= 2) {
                $("#Nombre").val(partes[0]);
                $("#Apellidos").val(partes.slice(1).join(" "));
            } else {
                $("#Nombre").val(nombreCompleto);
                $("#Apellidos").val("");
            }

            var texto = "";
            $block.find("p").each(function () {
                var t = $(this).text().replace(/\s+/g, " ").trim();
                texto += t + "||";
                if (/fecha nacimiento/i.test(t)) {
                    var m = t.match(/(\d{1,2})\D+(\d{1,2})\D+(\d{2,4})/);
                    if (m) {
                        var dd = m[1].padStart(2, '0');
                        var mm = m[2].padStart(2, '0');
                        var yyyy = m[3].length === 2 ? ('20' + m[3]) : m[3];
                        $("#FechaNacimiento").val(yyyy + "-" + mm + "-" + dd);
                    } else {
                        $("#FechaNacimiento").val("");
                    }
                } else if (/edad/i.test(t)) {
                    var m2 = t.match(/([0-9]{1,3})/);
                    $("#Edad").val(m2 ? m2[1] : "");
                } else if (/estado civil/i.test(t)) {
                    var v = t.split(":");
                    $("#EstadoCivil").val(v.length > 1 ? v.slice(1).join(":").trim() : "");
                } else if (/email/i.test(t)) {
                    var v = t.split(":");
                    $("#Email").val(v.length > 1 ? v.slice(1).join(":").trim() : "");
                } else if (/tel[eé]fono/i.test(t)) {
                    var v = t.split(":");
                    $("#Telefono").val(v.length > 1 ? v.slice(1).join(":").trim() : "");
                } else if (/dni/i.test(t)) {
                    var v = t.split(":");
                    $("#Dni").val(v.length > 1 ? v.slice(1).join(":").trim() : "");
                }
            });

            $("#modalActualizar").fadeIn(150);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function cerrarModalYRestaurar() {
            $("#modalActualizar").fadeOut(120);
            $("#formActualizarInline")[0].reset();
            $("#txtBuscar").val("");
            $("#resultadoEmpleado").html('<p>Ingrese un filtro y presione "Buscar" para ver los empleados.</p>');
        }

        $("#btnCancelarModal, #cerrarModal").on("click", function () {
            cerrarModalYRestaurar();
        });

        $("#formActualizarInline").on("submit", function (e) {
            e.preventDefault();
            var data = $(this).serialize();

            $(".btn-guardar-actualizar").prop("disabled", true);

            $.ajax({
                url: '/Actualizar/ActualizarEmpleadoAjax',
                method: 'POST',
                data: data,
                success: function (res) {
                    if (res && res.success) {
                        alert(res.message || "Actualizado correctamente.");
                        cerrarModalYRestaurar();
                    } else {
                        alert(res.message || "No se pudo actualizar. Revise los datos.");
                    }
                },
                error: function () {
                    alert("Error al intentar actualizar. Reintente.");
                },
                complete: function () {
                    $(".btn-guardar-actualizar").prop("disabled", false);
                }
            });
        });

        agregarBotonesActualizar();
    });
</script>
